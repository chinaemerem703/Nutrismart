<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NutriSmart Dashboard</title>
    <link rel="stylesheet" href="dashboard.css" />
    
      
  </head>
  <body class="dashboard-body">
    <!-- ==================== HEADER ==================== -->
    <header class="header">
      <div class="logo">
        <img
          src="images/landing-page-logo-image.png"
          alt="NutriSmart"
          width="30"
        />
        <span>Nutri<span class="span-b">Smart</span></span>
      </div>

      <div class="user-actions">
        <a href="settings.html"><button class="btn-profile">Profile</button></a>
        <button class="btn-logout" onclick="showLogoutModal()">Log out</button>
      </div>

      <!-- LOGOUT MODAL -->
      <div id="logoutModal" class="modal-overlay" style="display: none">
        <div class="modal-content">
          <h3>Confirm Logout</h3>
          <p>
            Are you sure you want to log out? You need to sign in again to
            access your account.
          </p>
          <div class="modal-buttons">
            <button class="btn-confirm" onclick="confirmLogout()">
              Log Out
            </button>
            <button class="btn-cancel" onclick="hideLogoutModal()">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- USER GREETING -->
      <div class="greeting">
        <img src="images/Frame 12.png" alt="User" class="avatar" />
        <h1>Hello, <span id="userName">User</span>!</h1>
      </div>

      <!-- STATS CARDS  -->
      <div class="stats-grid">
        <div class="stat-card">
          <p>Daily Goal</p>
          <h3>2000 kcal</h3>
          <span class="icon"><img src="images/Container.png" alt="" /></span>
        </div>
        <div class="stat-card">
          <p>Foods Tracked</p>
          <h3>12 today</h3>
          <span class="icon"
            ><img src="images/Container (1).png" alt=""
          /></span>
        </div>
        <div class="stat-card">
          <p>Streak</p>
          <h3>7 days</h3>
          <span class="icon"
            ><img src="images/Container (2).png" alt=""
          /></span>
        </div>
        <div class="stat-card">
          <p>Health Score</p>
          <h3>85/100</h3>
          <span class="icon"
            ><img src="images/Container (3).png" alt=""
          /></span>
        </div>
      </div>

      <!-- ==================== RECOMMENDED MEALS ==================== -->
      <section class="section">
        <h2>Recommended for You</h2>
        <p class="subtitle">Based on your health profile and goals</p>

        <!-- DYNAMIC CONTAINER (will be filled by JS) -->
        <div id="recommendations-container"></div>

        
    <div class="meal-card"> … </div>
    

        <a href="suggest.html"
          ><button class="btn-suggestions">
            View more meal suggestions
          </button></a
        >
      </section>

      <!-- TODAY'S TIPS  -->
      <section class="section">
        <h2>Today's Tips</h2>
        <ul class="tips-list">
          <li>Drink at least 8 glasses of water today</li>
          <li>Include leafy greens in your meals</li>
          <li>Take a 15-minute walk after meals</li>
        </ul>
        <a href="nutrition.html" class="view-all">View All Tips</a>
      </section>

      <!-- QUICK ACTIONS  -->
      <section class="section">
        <h2>Quick Actions</h2>
        <div class="quick-actions">
          <a href="library.html" class="action-item"
            ><img src="images/Icon.png" alt="" /> Browse Foods</a
          >
          <a href="progress-tracker.html" class="action-item"
            ><img src="images/Icon (1).png" alt="" /> View Progress</a
          >
          <a href="nutrition.html" class="action-item"
            ><img src="images/Icon (2).png" alt="" /> Nutrition Tips</a
          >
        </div>
      </section>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
   <script>
  const API_BASE = "https://nutri-smart-akeg.onrender.com";
  const STATE_KEY = "nutrismart_settings_state";

  
  if (!localStorage.getItem("authToken")) {
    window.location.href = "login.html";
  }

  function getToken() {
    return localStorage.getItem("authToken");
  }

  
  function loadUserName() {
    const saved = localStorage.getItem("user");
    if (saved) {
      const user = JSON.parse(saved);
      document.getElementById("userName").textContent = user.name || "User";
      return;
    }

    fetch(`${API_BASE}/profile/get`, {
      headers: { Authorization: `Bearer ${getToken()}` },
    })
      .then((r) => (r.ok ? r.json() : Promise.reject()))
      .then((data) => {
        if (data.name) {
          document.getElementById("userName").textContent = data.name;
          localStorage.setItem("user", JSON.stringify({ name: data.name }));
        }
      })
      .catch(() => {});
  }

  
  const CONDITION_MAP = {
    "High Blood Pressure": "Hypertension",
    "Heart Disease": "Heart Disease",
    "High Cholesterol": "High Cholesterol",
    "Obesity": "Obesity",
    "Diabetes": "Diabetes",
    "Ulcer": "Ulcer",
    "Anaemia": "Anaemia"
  };

  function toBackendCondition(uiName) {
    return CONDITION_MAP[uiName.trim()] || uiName.trim();
  }

  function toUICondition(backendName) {
    return Object.keys(CONDITION_MAP).find(key => CONDITION_MAP[key] === backendName) || backendName;
  }

  
  const LOCAL_RECS = {
    "Heart Disease": {
      condition: "Heart Disease",
      description: "Supports heart health and reduces risk",
      recommendedNutrients: "Omega-3, fiber, potassium",
      restrictedNutrients: "Saturated fats, sodium",
      recommendedFoods: "Salmon, walnuts, oats, berries",
      restrictedFoods: "Red meat, fried foods, processed snacks"
    },
    "High Cholesterol": {
      condition: "High Cholesterol",
      description: "Helps lower LDL cholesterol",
      recommendedNutrients: "Soluble fiber, plant sterols",
      restrictedNutrients: "Trans fats, saturated fats",
      recommendedFoods: "Oats, beans, apples, almonds",
      restrictedFoods: "Butter, pastries, full-fat dairy"
    }
  };

  /* ----------  LOAD RECOMMENDATIONS ---------- */
  async function loadRecommendations() {
    const container = document.getElementById("recommendations-container");
    if (!container) return;

    container.innerHTML = "<p class='loading'>Loading your personalized plan…</p>";

    const state = JSON.parse(localStorage.getItem(STATE_KEY) || "{}");
    const uiConditions = state.conditions
      ? state.conditions.split(',').map(s => s.trim()).filter(Boolean)
      : [];

    if (!uiConditions.length) {
      container.innerHTML = "<p>Complete your health profile to get recommendations.</p>";
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/meals/recommendations`, {
        headers: { "Authorization": `Bearer ${getToken()}` }
      });
      const data = await res.json();

      let backendRecs = [];
      if (res.ok && Array.isArray(data.recommendations)) {
        backendRecs = data.recommendations.map(rec => ({
          ...rec,
          condition: toUICondition(rec.condition) 
        }));
      }

      
      const finalRecs = uiConditions.map(cond => {
        const backendRec = backendRecs.find(r => r.condition === cond);
        if (backendRec) return backendRec;
        return LOCAL_RECS[cond] ? { ...LOCAL_RECS[cond], condition: cond } : null;
      }).filter(Boolean);

      renderRecommendations(finalRecs.length > 0 ? finalRecs : []);

    } catch (err) {
      console.error("Network error:", err);
      // Fallback to local only
      const localOnly = uiConditions.map(cond => LOCAL_RECS[cond] ? { ...LOCAL_RECS[cond], condition: cond } : null).filter(Boolean);
      renderRecommendations(localOnly.length > 0 ? localOnly : []);
      container.innerHTML = `<p class="error">Using offline data (check internet).</p>` + container.innerHTML;
    }
  }

  /* ---------- 6. RENDER RECOMMENDATIONS ---------- */
  function renderRecommendations(recs) {
    const container = document.getElementById("recommendations-container");

    if (!recs.length) {
      container.innerHTML = "<p>No recommendations available.</p>";
      return;
    }

    const html = recs
      .map(
        (rec) => `
          <div class="rec-card">
            <h3>${rec.condition}</h3>
            <p><strong>Goal:</strong> ${rec.description || "-"}</p>
            <p><strong>Recommended:</strong> ${rec.recommendedFoods || "-"}</p>
            <p><strong>Avoid:</strong> ${rec.restrictedFoods || "-"}</p>

            ${
              rec.matchedMeals?.length
                ? `
                  <div class="meals">
                    ${rec.matchedMeals
                      .map(
                        (m) => `
                          <div class="meal-card">
                            <img src="${m.image || "images/jollof-rice.png"}" alt="${m.name}">
                            <div class="meal-info">
                              <h4>${m.name}</h4>
                              <p>${m.calories} kcal • ${m.protein ? m.protein + "g protein" : "Protein-rich"}</p>
                            </div>
                            <button class="btn-add">suitable</button>
                          </div>
                        `
                      )
                      .join("")}
                  </div>
                `
                : ""
            }
          </div>
        `
      )
      .join("");

    container.innerHTML = html;
  }

  /* ---------- 7. LOGOUT MODAL ---------- */
  function showLogoutModal() {
    document.getElementById("logoutModal").style.display = "flex";
  }
  function hideLogoutModal() {
    document.getElementById("logoutModal").style.display = "none";
  }
  function confirmLogout() {
    hideLogoutModal();
    localStorage.removeItem("authToken");
    localStorage.removeItem("user");
    window.location.href = "login.html";
  }

  /* ---------- 8. PAGE LOAD ---------- */
  document.addEventListener("DOMContentLoaded", () => {
    loadUserName();
    loadRecommendations();
  });
</script>